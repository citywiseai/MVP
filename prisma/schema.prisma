generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://postgres:postgres@localhost:5432/rezio_dev?schema=public"
}

enum UserRole {
  HOMEOWNER
  BUILDER
  DEVELOPER
  ARCHITECT
  ENGINEER
  REAL_ESTATE
  OTHER
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String?
  password            String?
  phone               String?
  role                UserRole?
  companyName         String?
  licenseNumber       String?
  serviceArea         String?
  businessAddress     String?
  projectTypes        String[]  @default([])
  challenges          String[]  @default([])
  onboardingCompleted Boolean   @default(false)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  memberships   Membership[]
  notes         Note[]
  ownedProjects Project[]     @relation("ProjectOwner")
  uploadedFiles ProjectFile[] @relation("UploadedFiles")
  chatMessages  ChatMessage[]
}

model Org {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  projects    Project[]
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  orgId     String
  role      String   @default("member")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
}

model Project {
  id           String   @id @default(cuid())
  name         String
  description  String?
  status       String   @default("active")
  fullAddress  String?
  propertyType String?
  projectType  String?
  ownerId      String
  orgId        String?
  parcelId     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  owner           User                     @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  org             Org?                     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  parcel          Parcel?                  @relation(fields: [parcelId], references: [id])
  tasks           Task[]
  notes           Note[]
  files           ProjectFile[]
  engineeringReqs EngineeringRequirement[]
  drawnShapes     DrawnShape[]
  chatMessages    ChatMessage[]
}

model Parcel {
  id                  String   @id @default(cuid())
  apn                 String   @unique
  address             String?
  city                String?
  state               String?
  zipCode             String?
  county              String?
  zoning              String?
  lotSizeSqFt         Float?
  latitude            Float?
  longitude           Float?
  boundaryCoordinates Json?
  zoningRules         Json?
  propertyMetadata    Json?
  existingSqFt        Float?
  setbacks            Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  projects Project[]
}

model Task {
  id                String   @id @default(cuid())
  title             String
  description       String?
  status            String   @default("TODO")
  priority          String   @default("MEDIUM")
  projectId         String
  assignedTo        String?
  lastStatusChange  DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Note {
  id        String   @id @default(cuid())
  content   String
  projectId String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model EngineeringRequirement {
  id         String   @id @default(cuid())
  projectId  String
  discipline String
  required   Boolean  @default(true)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectFile {
  id         String   @id @default(cuid())
  projectId  String
  fileName   String
  fileUrl    String
  fileType   String?
  uploadedBy String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader User    @relation("UploadedFiles", fields: [uploadedBy], references: [id])
}

model ChatMessage {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String
  content   String
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}
// ============================================
// MUNICIPAL REQUIREMENTS DATABASE
// ============================================

enum RequirementType {
  PERMIT
  ENGINEERING
  REVIEW
  INSPECTION
  STUDY
}

enum ProjectType {
  ADDITION
  REMODEL
  ADU
  NEW_CONSTRUCTION
  DEMOLITION
  GARAGE_CONVERSION
  PATIO_COVER
  FENCE
  POOL
  SOLAR
}

enum TriggerOperator {
  GREATER_THAN
  GREATER_THAN_OR_EQUAL
  LESS_THAN
  LESS_THAN_OR_EQUAL
  EQUALS
  NOT_EQUALS
  INCLUDES
  EXISTS
}

model Jurisdiction {
  id                    String                @id @default(cuid())
  name                  String                @unique
  fullName              String
  state                 String                @default("Arizona")
  phone                 String?
  website               String?
  permitPortalUrl       String?
  typicalReviewDays     Int?
  expressPermitDays     Int?
  zoningCodes           ZoningCode[]
  requirements          MunicipalRequirement[]
  rules                 RequirementRule[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@index([name])
}

model ZoningCode {
  id                    String                @id @default(cuid())
  jurisdiction          Jurisdiction          @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  jurisdictionId        String
  code                  String
  name                  String
  description           String?
  frontSetback          Float?
  rearSetback           Float?
  sideSetback           Float?
  maxLotCoverage        Float?
  maxHeight             Float?
  rules                 RequirementRule[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@unique([jurisdictionId, code])
  @@index([jurisdictionId])
  @@index([code])
}

model MunicipalRequirement {
  id                    String                @id @default(cuid())
  jurisdiction          Jurisdiction          @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  jurisdictionId        String
  name                  String
  type                  RequirementType
  category              String?
  description           String                @db.Text
  typicalCostRange      String?
  typicalTimeframe      String?
  providedBy            String?
  appliesToProjectTypes ProjectType[]
  rules                 RequirementRule[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@unique([jurisdictionId, name])
  @@index([jurisdictionId])
  @@index([type])
}

model RequirementRule {
  id                    String                @id @default(cuid())
  jurisdiction          Jurisdiction          @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  jurisdictionId        String
  name                  String
  description           String?               @db.Text
  projectTypes          ProjectType[]
  zoningCodes           ZoningCode[]
  requirement           MunicipalRequirement  @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  requirementId         String
  triggers              RuleTrigger[]
  priority              Int                   @default(0)
  isActive              Boolean               @default(true)
  sourceDocument        String?
  notes                 String?               @db.Text
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@index([jurisdictionId])
  @@index([requirementId])
}

model RuleTrigger {
  id                    String                @id @default(cuid())
  rule                  RequirementRule       @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  ruleId                String
  fieldName             String
  operator              TriggerOperator
  value                 String
  description           String?
  createdAt             DateTime              @default(now())
  
  @@index([ruleId])
}


model DrawnShape {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  shapeType   String   // 'polygon', 'rectangle', 'circle', 'house', 'garage', 'adu'
  coordinates Json     // GeoJSON coordinates array
  area        Float    // Square feet
  perimeter   Float    // Feet
  properties  Json?    // Additional properties (stories, height, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}
