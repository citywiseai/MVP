generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  memberships   Membership[]
  tasks         Task[]
  notes         Note[]
  ownedProjects Project[] @relation("ProjectOwner")
  uploadedFiles ProjectFile[] @relation("UploadedFiles")
  chatMessages  ChatMessage[]
}

model Org {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  memberships   Membership[]
  projects      Project[]
}

model Membership {
  id            String    @id @default(cuid())
  role          String
  userId        String
  orgId         String
  createdAt     DateTime  @default(now())

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  org           Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
}

model Project {
  id                    String    @id @default(cuid())
  name                  String
  description           String?
  status                String    @default("active")
  orgId                 String
  userId                String?
  parcelId              String?
  
  // Address and location fields
  fullAddress           String?
  propertyType          String?   // Commercial, Residential, Multi-family, Mixed-use
  jurisdiction          String?
  projectType           String?   // From dropdown
  mainContact           String?
  lotSizeSqFt           Int?
  buildingFootprintSqFt Int?
  totalSfModified       Int?
  outsideFootprintSf    Int?
  hillsideGrade         Boolean   @default(false)
  onSeptic              Boolean   @default(false)
  scopeOfWork           String?   @db.Text
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  org                   Org              @relation(fields: [orgId], references: [id], onDelete: Cascade)
  parcel                Parcel?          @relation(fields: [parcelId], references: [id])
  tasks                 Task[]
  notes                 Note[]
  owner                 User?            @relation("ProjectOwner", fields: [userId], references: [id])
  engineeringReqs       EngineeringRequirement[]
  projectFiles          ProjectFile[]
  chatMessages          ChatMessage[]
}

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("TODO")
  projectId   String
  userId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])
}

model Note {
  id        String   @id @default(cuid())
  content   String   @db.Text
  projectId String
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])
}

model EngineeringRequirement {
  id          String   @id @default(cuid())
  requirement String   @db.Text
  discipline  String?  // The engineering discipline (Structural, MEP, etc.)
  required    Boolean  @default(false)
  notes       String?  @db.Text
  projectId   String
  custom      Boolean  @default(false) // True if user-edited or user-added
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Parcel {
  id          String    @id @default(cuid())
  apn         String?   @unique  // Assessor's Parcel Number
  address     String?
  city        String?
  state       String?
  zipCode     String?
  county      String?
  jurisdiction String?
  acreage     Float?
  sqft        Int?
  lotSizeSqFt Int?
  zoning      String?
  zoningCode  String?
  landUse     String?
  latitude    Float?
  longitude   Float?
  boundaryCoordinates Json? // Array of [lng, lat] pairs
  zoningRules Json[]    @default([])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  projects    Project[]
}

model ProjectFile {
  id          String   @id @default(cuid())
  filename    String
  originalName String
  filepath    String?
  mimeType    String
  size        Int
  projectId   String
  uploadedBy  String?
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader    User?    @relation("UploadedFiles", fields: [uploadedBy], references: [id])
}

model ChatMessage {
  id          String   @id @default(cuid())
  message     String   @db.Text
  response    String   @db.Text
  role        String   // 'user' or 'assistant'
  projectId   String
  userId      String?
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])

  @@index([projectId, createdAt])
}