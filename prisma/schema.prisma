generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  HOMEOWNER
  BUILDER
  DEVELOPER
  ARCHITECT
  ENGINEER
  REAL_ESTATE
  OTHER
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String?
  password            String?
  phone               String?
  role                UserRole?
  companyName         String?
  licenseNumber       String?
  serviceArea         String?
  businessAddress     String?
  projectTypes        String[]  @default([])
  challenges          String[]  @default([])
  onboardingCompleted Boolean   @default(false)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  memberships   Membership[]
  notes         Note[]
  ownedProjects Project[]     @relation("ProjectOwner")
  uploadedFiles ProjectFile[] @relation("UploadedFiles")
  chatMessages  ChatMessage[]
}

model Org {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  projects    Project[]
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  orgId     String
  role      String   @default("member")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
}

model Project {
  id                String   @id @default(cuid())
  name              String
  description       String?
  status            String   @default("active")
  fullAddress       String?
  propertyType      String?
  projectType       String?
  ownerId           String
  orgId             String?
  parcelId          String?
  zoningDistrictId  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Project management fields
  priority          String   @default("medium")  // "high", "medium", "low"
  dueDate           DateTime?
  projectNotes      String?
  clientName        String?
  tags              String[] @default([])
  archivedAt        DateTime?

  owner           User                     @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  org             Org?                     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  parcel          Parcel?                  @relation(fields: [parcelId], references: [id])
  zoningDistrict  ZoningDistrict?          @relation(fields: [zoningDistrictId], references: [id])
  tasks           Task[]
  notes           Note[]
  files           ProjectFile[]
  engineeringReqs EngineeringRequirement[]
  drawnShapes     DrawnShape[]
  chatMessages    ChatMessage[]
  measurements    Measurement[]
  roadmap         ProjectRoadmap?
}

model Parcel {
  id                  String   @id @default(cuid())
  apn                 String   @unique
  address             String?
  city                String?
  state               String?
  zipCode             String?
  county              String?
  zoning              String?
  lotSizeSqFt         Float?
  latitude            Float?
  longitude           Float?
  boundaryCoordinates Json?
  zoningRules         Json?
  propertyMetadata    Json?
  existingSqFt        Float?
  setbacks            Json?
  edgeLabels          Json?  // Store edge labels: [{ edgeIndex: 0, side: 'front' }, ...]
  assessorUrl          String?
  totalBuildingSF      Float?
  buildingSections     Json?
  assessorDataFetchedAt DateTime?
  buildingSketchesImage String?  @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  projects Project[]
}

model Task {
  id                String   @id @default(cuid())
  title             String
  description       String?
  status            String   @default("TODO")
  priority          String   @default("MEDIUM")
  projectId         String
  assignedTo        String?
  phaseId           String?
  lastStatusChange  DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase   RoadmapPhase? @relation(fields: [phaseId], references: [id], onDelete: SetNull)
}

model Note {
  id        String   @id @default(cuid())
  content   String
  projectId String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model EngineeringRequirement {
  id         String   @id @default(cuid())
  projectId  String
  discipline String
  required   Boolean  @default(true)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectFile {
  id         String   @id @default(cuid())
  projectId  String
  fileName   String
  fileUrl    String
  fileType   String?
  uploadedBy String
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader User    @relation("UploadedFiles", fields: [uploadedBy], references: [id])
}

model ChatMessage {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String
  content   String
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ExplorationConversation {
  id        String   @id @default(cuid())
  userId    String?
  messages  Json     // Array of {role, content}
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// ZONING SYSTEM
// ============================================

model Municipality {
  id              String           @id @default(cuid())
  name            String
  state           String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  zoningDistricts ZoningDistrict[]

  @@index([name])
  @@index([state])
}

model ZoningDistrict {
  id             String        @id @default(cuid())
  municipalityId String
  municipality   Municipality  @relation(fields: [municipalityId], references: [id], onDelete: Cascade)
  code           String        // e.g., "R-1-6", "R-2"
  name           String        // e.g., "Single-Family Residential"
  description    String?       @db.Text
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  zoningRules    ZoningRule[]
  projects       Project[]

  @@unique([municipalityId, code])
  @@index([municipalityId])
  @@index([code])
}

enum RuleCategory {
  SETBACK
  LOT_COVERAGE
  HEIGHT
  PARKING
  LOT_SIZE
  OTHER
}

model ZoningRule {
  id               String         @id @default(cuid())
  zoningDistrictId String
  zoningDistrict   ZoningDistrict @relation(fields: [zoningDistrictId], references: [id], onDelete: Cascade)
  category         RuleCategory
  name             String         // e.g., "Front Setback", "Maximum Height"
  valueNumber      Float?         // numeric values like 20 for 20 feet
  valueText        String?        // complex rules like "2 spaces per unit"
  unit             String?        // e.g., "feet", "percent", "spaces"
  projectTypes     String[]       // matches Project.projectType values
  description      String?        @db.Text
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([zoningDistrictId])
  @@index([category])
}

// ============================================
// MUNICIPAL REQUIREMENTS DATABASE
// ============================================

enum RequirementType {
  PERMIT
  ENGINEERING
  REVIEW
  INSPECTION
  STUDY
}

enum ProjectType {
  ADDITION
  REMODEL
  ADU
  NEW_CONSTRUCTION
  DEMOLITION
  GARAGE_CONVERSION
  PATIO_COVER
  FENCE
  POOL
  SOLAR
}

enum TriggerOperator {
  GREATER_THAN
  GREATER_THAN_OR_EQUAL
  LESS_THAN
  LESS_THAN_OR_EQUAL
  EQUALS
  NOT_EQUALS
  INCLUDES
  EXISTS
}

model Jurisdiction {
  id                    String                @id @default(cuid())
  name                  String                @unique
  fullName              String
  state                 String                @default("Arizona")
  phone                 String?
  website               String?
  permitPortalUrl       String?
  typicalReviewDays     Int?
  expressPermitDays     Int?
  zoningCodes           ZoningCode[]
  requirements          MunicipalRequirement[]
  rules                 RequirementRule[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@index([name])
}

model ZoningCode {
  id                    String                @id @default(cuid())
  jurisdiction          Jurisdiction          @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  jurisdictionId        String
  code                  String
  name                  String
  description           String?
  frontSetback          Float?
  rearSetback           Float?
  sideSetback           Float?
  maxLotCoverage        Float?
  maxHeight             Float?
  rules                 RequirementRule[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@unique([jurisdictionId, code])
  @@index([jurisdictionId])
  @@index([code])
}

model MunicipalRequirement {
  id                    String                @id @default(cuid())
  jurisdiction          Jurisdiction          @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  jurisdictionId        String
  name                  String
  type                  RequirementType
  category              String?
  description           String                @db.Text
  typicalCostRange      String?
  typicalTimeframe      String?
  providedBy            String?
  appliesToProjectTypes ProjectType[]
  rules                 RequirementRule[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@unique([jurisdictionId, name])
  @@index([jurisdictionId])
  @@index([type])
}

model RequirementRule {
  id                    String                @id @default(cuid())
  jurisdiction          Jurisdiction          @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  jurisdictionId        String
  name                  String
  description           String?               @db.Text
  projectTypes          ProjectType[]
  zoningCodes           ZoningCode[]
  requirement           MunicipalRequirement  @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  requirementId         String
  triggers              RuleTrigger[]
  priority              Int                   @default(0)
  isActive              Boolean               @default(true)
  sourceDocument        String?
  notes                 String?               @db.Text
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@index([jurisdictionId])
  @@index([requirementId])
}

model RuleTrigger {
  id                    String                @id @default(cuid())
  rule                  RequirementRule       @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  ruleId                String
  fieldName             String
  operator              TriggerOperator
  value                 String
  description           String?
  createdAt             DateTime              @default(now())
  
  @@index([ruleId])
}


model DrawnShape {
  id            String   @id @default(cuid())
  projectId     String
  name          String
  shapeType     String   // 'polygon', 'rectangle', 'circle', 'house', 'garage', 'adu'
  coordinates   Json     // GeoJSON coordinates array
  area          Float    // Square feet
  perimeter     Float    // Feet
  rotationAngle Float    @default(0) // Rotation angle in degrees (0-360)
  properties    Json?    // Additional properties (stories, height, etc.)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Measurement {
  id               String   @id @default(cuid())
  projectId        String
  name             String   // User-provided name for the measurement
  measurementType  String   // 'line' or 'polyline'
  points           Json     // Array of {lat: number, lng: number}
  totalDistance    Float    // Total distance in feet
  segmentDistances Json?    // Array of segment distances for polylines
  displayDistance  String?  // User override for displayed distance (e.g. "25' 6\"" or "25.5'")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ============================================
// PHOENIX ZONING REQUIREMENTS
// ============================================

model PhoenixZoning {
  id              String   @id @default(cuid())
  jurisdiction    String   // "Phoenix, AZ"
  zoningDistrict  String   // "RE-43", "R1-6", etc.
  districtName    String   // Full name like "Residential Estate RE-43 District"

  // Setbacks in feet
  frontSetback    Float
  sideSetback     Float
  rearSetback     Float

  // Lot requirements
  lotCoverageMax  Float?   // e.g., 0.20 for 20%
  maxHeight       Float?   // in feet
  maxStories      Int?     // number of stories
  minLotSize      Float?   // in square feet
  minLotWidth     Float?   // in feet
  minLotDepth     Float?   // in feet

  // ADU regulations (Section 706)
  aduAllowed      Boolean  @default(false)
  maxADUs         Int?     // maximum number of ADUs allowed
  aduMinSetback   Float?   // ADU setback from property line (typically 3-5 ft)
  aduMaxSize      Float?   // Max sq ft for ADU
  aduMaxHeight    Float?   // Max height for ADU (often less than primary)

  // Parking requirements (Section 702)
  parkingPerUnit  Float?   // e.g., 2.0 for 2 spaces per dwelling
  coveredParking  Boolean? // Covered parking required?

  // Design requirements
  fenceMaxHeight  Float?   // Max fence height in front yard
  landscapeReq    String?  // Landscaping requirements summary

  // Special rules
  permittedUses   String?  @db.Text // JSON array of main permitted uses
  specialRules    String?  @db.Text // Any special requirements

  // Context
  description     String?  @db.Text
  sourceUrl       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([jurisdiction, zoningDistrict])
  @@index([jurisdiction])
  @@index([zoningDistrict])
}

// ============================================
// PROJECT ROADMAP SYSTEM
// ============================================

model ProjectRoadmap {
  id        String   @id @default(cuid())
  projectId String   @unique
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  phases    RoadmapPhase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("project_roadmaps")
}

model RoadmapPhase {
  id          String   @id @default(cuid())
  roadmapId   String
  roadmap     ProjectRoadmap @relation(fields: [roadmapId], references: [id], onDelete: Cascade)

  name        String   // "Discovery & Site Analysis"
  order       Int      // 1-6
  status      String   @default("waiting") // waiting, in_progress, completed

  // Timing
  estimatedDuration String?  // "2-4 weeks"
  startDate         DateTime?
  endDate           DateTime?

  // Services included in this phase
  services    Json     // Array of service objects

  // Progress tracking
  progress    Int      @default(0) // 0-100

  // Metadata
  description String?
  dependencies String[] // Array of phase IDs this depends on

  tasks       Task[]   // Tasks assigned to this phase

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roadmap_phases")
}
